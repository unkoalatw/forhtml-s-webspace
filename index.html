<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AntiKick Web 3.0 (Alpine + Tailwind)</title>

    <!-- 1. Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        app: '#FAFAFA',
                        card: '#FFFFFF',
                        primary: '#171717',
                        secondary: '#737373',
                        tertiary: '#A3A3A3',
                        online: '#22C55E',
                        busy: '#EF4444',
                        offline: '#D4D4D4'
                    },
                    boxShadow: {
                        subtle: '0 4px 20px -2px rgba(0, 0, 0, 0.03)',
                        float: '0 10px 40px -10px rgba(0, 0, 0, 0.08)'
                    }
                }
            }
        }
    </script>
    <style>
        /* Ë£úÂÖÖ Tailwind ÁÑ°Ê≥ïÂÆåÂÖ®ÂáΩËìãÁöÑÁ¥∞ÁØÄ */
        body {
            -webkit-tap-highlight-color: transparent;
        }

        .btn-press:active {
            transform: scale(0.96);
        }

        .pulse-ring::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background-color: inherit;
            opacity: 0.4;
            animation: pulse-r 2s infinite;
        }

        @keyframes pulse-r {
            0% {
                transform: scale(1);
                opacity: 0.4;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        [x-cloak] {
            display: none !important;
        }
    </style>

    <!-- 2. Alpine.js (CDN) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</head>

<body
    class="bg-app text-primary min-h-screen flex flex-col font-sans pb-24 overflow-x-hidden antialiased selection:bg-gray-200"
    x-data="app()" x-init="initApp()" @auth-change.window="handleAuth($event.detail)"
    @status-change.window="handleStatus($event.detail)" @friends-change.window="friends = $event.detail">

    <div class="w-full max-w-[460px] mx-auto px-5 py-6">

        <!-- Header -->
        <div class="pt-10 pb-5 px-2 flex justify-between items-end">
            <h1 class="text-3xl font-extrabold tracking-tight leading-none">AntiKick</h1>
            <div class="flex items-center gap-1.5 text-[13px] font-medium text-secondary">
                <div class="w-2 h-2 rounded-full relative" :class="{
                        'bg-online pulse-ring': connState === 'online',
                        'bg-busy pulse-ring': connState === 'danger',
                        'bg-offline': connState === 'offline'
                     }"></div>
                <span x-text="connText">Init...</span>
            </div>
        </div>

        <!-- AUTH PAGE -->
        <div x-show="page === 'auth'" x-transition.opacity.duration.300ms class="space-y-5">
            <div class="bg-card rounded-3xl shadow-subtle p-8 text-center transition hover:shadow-float">
                <h2 class="text-2xl font-bold mb-2">Ê≠°ËøéÂõû‰æÜ</h2>
                <p class="text-secondary mb-8">Web 3.0 (Tailwind + Alpine)</p>

                <!-- Buttons -->
                <button @click="actions.loginGoogle"
                    class="w-full py-4 rounded-2xl bg-[#4285F4] text-white font-semibold shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 btn-press transition">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="#FFF">
                        <path
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                        <path
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                        <path
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" />
                        <path
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                    </svg>
                    ‰ΩøÁî® Google ÁôªÂÖ•
                </button>

                <div class="relative py-5 text-center text-[13px] text-tertiary">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-100"></div>
                    </div>
                    <span class="relative bg-card px-2">ÊàñËÄÖ</span>
                </div>

                <!-- Email Form -->
                <div x-show="showEmailForm" x-collapse>
                    <div class="space-y-4 text-left mb-4">
                        <div>
                            <label class="block text-xs font-bold text-secondary uppercase mb-2">Email</label>
                            <input x-model="email" type="email"
                                class="w-full p-4 rounded-2xl border-2 border-gray-100 bg-card text-primary focus:border-primary focus:bg-app outline-none transition"
                                placeholder="name@example.com">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-secondary uppercase mb-2">Password</label>
                            <input x-model="password" type="password"
                                class="w-full p-4 rounded-2xl border-2 border-gray-100 bg-card text-primary focus:border-primary focus:bg-app outline-none transition"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    <button @click="actions.loginEmail(email, password)"
                        class="w-full py-4 mb-3 rounded-2xl bg-primary text-white font-semibold shadow-xl shadow-black/10 btn-press transition">ÁôªÂÖ•
                        / Ë®ªÂÜä</button>
                    <button @click="showEmailForm = false"
                        class="w-full py-2 text-sm text-secondary hover:text-primary transition">ËøîÂõû</button>
                </div>

                <div x-show="!showEmailForm">
                    <button @click="showEmailForm = true"
                        class="w-full py-4 mb-3 rounded-2xl border-2 border-gray-100 text-secondary font-semibold hover:border-gray-200 btn-press transition">‰ΩøÁî®
                        Email ÁôªÂÖ•</button>
                    <button @click="actions.loginGuest"
                        class="text-sm text-secondary hover:text-primary transition p-2">‰ª•Ë®™ÂÆ¢Ë∫´ÂàÜÁπºÁ∫å</button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div x-show="page === 'dashboard'" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
            class="space-y-5" x-cloak>

            <!-- Status Card -->
            <div class="bg-card rounded-3xl shadow-subtle p-8 text-center transition-all duration-300"
                :class="{'shadow-float bg-white': !status.inUse, 'bg-gray-50 border border-gray-100': status.inUse}">

                <div class="text-5xl mb-4" x-text="statusUI.icon"></div>
                <div class="text-2xl font-bold tracking-tight mb-2 text-primary" x-text="statusUI.title"></div>
                <div class="text-sm text-secondary leading-relaxed min-h-[22px]" x-text="statusUI.subtitle"></div>

                <div class="mt-8 flex flex-col gap-3">
                    <!-- Actions -->
                    <template x-if="statusUI.canGoOnline">
                        <button @click="updateStatus('online')"
                            class="w-full py-4 rounded-2xl bg-primary text-white font-bold shadow-xl shadow-black/10 flex items-center justify-center gap-2 btn-press transition">
                            ‚ö° ‰∏äÁ∑ö (Go Online)
                        </button>
                    </template>

                    <template x-if="statusUI.canGoOffline">
                        <button @click="updateStatus('offline')"
                            class="w-full py-4 rounded-2xl bg-gray-200 text-secondary font-bold flex items-center justify-center gap-2 btn-press transition hover:bg-gray-300 hover:text-primary">
                            üí§ ‰∏ãÁ∑ö (Go Offline)
                        </button>
                    </template>

                    <template x-if="statusUI.canUrgent">
                        <button @click="confirmAction('urgent')"
                            class="w-full py-4 rounded-2xl border-2 border-busy text-busy font-bold flex items-center justify-center gap-2 btn-press transition hover:bg-red-50">
                            ‚ö†Ô∏è ÁôºÈÄÅÁ∑äÊÄ•Ë´ãÊ±Ç
                        </button>
                    </template>
                </div>
            </div>

            <!-- Info Card -->
            <div class="bg-card rounded-3xl shadow-subtle p-5">
                <h4 class="mb-3 text-xs font-bold text-secondary uppercase tracking-wider">Session Info</h4>
                <div class="flex justify-between py-2 border-b border-gray-100 items-baseline">
                    <span class="text-secondary text-sm">‰ΩøÁî®ËÄÖ</span>
                    <span class="font-bold text-primary truncate max-w-[150px]" x-text="niceID(user?.email)"></span>
                </div>
                <div class="flex justify-between py-2 text-xs items-baseline">
                    <span class="text-secondary">GAS Status</span>
                    <span class="font-medium text-tertiary" x-text="gasStatus">Idle</span>
                </div>
            </div>
        </div>

        <!-- FRIENDS -->
        <div x-show="page === 'friends'" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
            class="space-y-5" x-cloak>
            <div class="bg-card rounded-3xl shadow-subtle p-6 text-center">
                <div class="text-secondary text-sm mb-2">ÊÇ®ÁöÑÂ•ΩÂèã‰ª£Á¢º (ID)</div>
                <div @click="copyCode"
                    class="inline-block bg-gray-100 px-4 py-2 rounded-xl font-mono text-base tracking-widest text-primary cursor-pointer active:scale-95 transition select-all"
                    x-text="user?.uid || '---'"></div>
                <div class="text-xs text-tertiary mt-2">ÈªûÊìäË§áË£Ω</div>
            </div>

            <div>
                <label class="block text-xs font-bold text-secondary uppercase mb-2 pl-1">Add Friend</label>
                <div class="flex gap-2">
                    <input x-model="friendInput" type="text"
                        class="flex-1 p-4 rounded-2xl border-2 border-gray-100 bg-card text-primary focus:border-primary outline-none transition"
                        placeholder="Ëº∏ÂÖ•Â•ΩÂèã ID">
                    <button @click="addFriend"
                        class="px-6 rounded-2xl bg-primary text-white font-bold shadow-lg btn-press transition">Add</button>
                </div>
            </div>

            <div>
                <div class="text-lg font-bold text-primary mb-4 px-1">Â•ΩÂèãÂàóË°®</div>
                <div class="space-y-3">
                    <template x-for="(f, fid) in friends" :key="fid">
                        <div class="flex items-center justify-between p-4 bg-card rounded-2xl shadow-subtle">
                            <div>
                                <div class="font-bold text-sm text-primary" x-text="f.name || f.email || 'Friend'">
                                </div>
                                <div class="text-xs text-secondary mt-0.5 font-mono" x-text="f.friendCode || fid"></div>
                            </div>
                            <button @click="removeFriend(fid)"
                                class="text-sm text-busy font-medium hover:opacity-70 px-2 py-1">ÁßªÈô§</button>
                        </div>
                    </template>
                    <div x-show="Object.keys(friends).length === 0" class="text-center text-tertiary py-8 text-sm">
                        Â∞öÁÑ°Â•ΩÂèã
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS -->
        <div x-show="page === 'settings'" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
            class="space-y-5" x-cloak>
            <div class="bg-card rounded-3xl shadow-subtle p-6 space-y-4">
                <h3 class="text-lg font-bold mb-2">Â∏≥ËôüË≥áË®ä</h3>
                <div>
                    <div class="text-xs font-bold text-secondary uppercase mb-1">Email / ID</div>
                    <div class="text-lg font-semibold break-all" x-text="user?.email || 'Guest'"></div>
                </div>
                <div>
                    <div class="text-xs font-bold text-secondary uppercase mb-1">ÁãÄÊÖã</div>
                    <div class="text-sm text-online flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-online"></span> Á≥ªÁµ±Ê≠£Â∏∏ÈÅã‰Ωú‰∏≠
                    </div>
                </div>
            </div>
            <button @click="actions.logout"
                class="w-full py-4 rounded-2xl border-2 border-gray-200 text-secondary font-bold hover:border-gray-300 hover:text-primary transition">ÁôªÂá∫</button>
        </div>

    </div>

    <!-- Bottom Nav -->
    <div x-show="user" x-transition
        class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-md rounded-full shadow-float p-1.5 flex z-50 border border-black/5 max-w-[90%]"
        x-cloak>
        <button @click="page = 'dashboard'"
            :class="page === 'dashboard' ? 'bg-primary text-white shadow-md' : 'text-secondary hover:bg-gray-100'"
            class="px-6 py-3 rounded-full text-sm font-bold transition-all duration-200">Home</button>
        <button @click="page = 'friends'"
            :class="page === 'friends' ? 'bg-primary text-white shadow-md' : 'text-secondary hover:bg-gray-100'"
            class="px-6 py-3 rounded-full text-sm font-bold transition-all duration-200">Friends</button>
        <button @click="page = 'settings'"
            :class="page === 'settings' ? 'bg-primary text-white shadow-md' : 'text-secondary hover:bg-gray-100'"
            class="px-6 py-3 rounded-full text-sm font-bold transition-all duration-200">Settings</button>
    </div>

    <!-- Modals -->
    <!-- Generic Modal Overlay -->
    <div x-show="modal.type" x-transition.opacity
        class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[200] flex items-center justify-center pointer-events-auto"
        x-cloak>
        <div x-show="modal.type" x-transition:enter="transition ease-spring duration-300"
            x-transition:enter-start="scale-90 opacity-0" x-transition:enter-end="scale-100 opacity-100"
            class="bg-white p-8 rounded-[32px] w-[85%] max-w-[340px] text-center shadow-float">
            <h2 class="text-xl font-extrabold mb-3 text-primary" x-text="modal.title">Title</h2>
            <p class="text-secondary mb-6 leading-relaxed" x-text="modal.text">Text</p>
            <div class="flex flex-col gap-3">
                <button @click="modal.confirm()"
                    class="w-full py-3.5 rounded-2xl bg-primary text-white font-bold shadow-lg btn-press"
                    x-text="modal.confirmText">Confirm</button>
                <button @click="modal.type = null"
                    class="w-full py-3.5 rounded-2xl border-2 border-gray-100 text-secondary font-bold hover:bg-gray-50 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div x-show="toast.visible" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 -translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 -translate-y-4"
        class="fixed top-6 left-1/2 -translate-x-1/2 bg-white px-6 py-3 rounded-full shadow-float z-[300] flex items-center gap-2 font-bold text-sm pointer-events-none"
        :style="toast.isError ? 'color: var(--status-busy)' : 'color: var(--text-primary)'" x-cloak>
        <span x-text="toast.isError ? '‚úï' : '‚úì'"></span>
        <span x-text="toast.msg">Success</span>
    </div>

    <!-- Alpine Logic -->
    <script>
        function app() {
            return {
                page: 'auth',
                user: null,
                connState: 'offline', // offline, online, danger
                connText: 'Init...',
                gasStatus: 'Idle',

                // Form Data
                email: '',
                password: '',
                showEmailForm: false,
                friendInput: '',

                // Data
                status: { inUse: false },
                friends: {},

                // UI State
                toast: { visible: false, msg: '', isError: false },
                modal: { type: null, title: '', text: '', confirm: null, confirmText: 'OK' },

                // Computed UI
                get statusUI() {
                    const myUid = this.user?.uid;
                    const data = this.status;

                    if (!data.inUse) {
                        return { icon: 'üõ°Ô∏è', title: 'Safe to Use', subtitle: 'ÁõÆÂâçÊ≤í‰∫∫‰ΩøÁî®', canGoOnline: true, canGoOffline: false, canUrgent: false };
                    }
                    if (data.currentUserId === myUid) {
                        // Check Urgent Request
                        if (data.urgentRequest && data.urgentRequest.from && this.modal.type !== 'urgentRecv') {
                            this.showUrgentReceived(data.urgentRequest.from);
                        }
                        return { icon: '‚ö°', title: 'You are Online', subtitle: 'ÊÇ®Ê≠£Âú®‰ΩøÁî®Â∏≥Ëôü', canGoOnline: false, canGoOffline: true, canUrgent: false };
                    }
                    return { icon: '‚õî', title: 'Occupied', subtitle: `${data.currentUser || 'Someone'} Ê≠£Âú®‰ΩøÁî®‰∏≠`, canGoOnline: false, canGoOffline: false, canUrgent: true };
                },

                // Init
                initApp() {
                    // Pre-bind actions to window for Firebase module to use event dispatching if needed, 
                    // or we use custom events. Here we listen to windows events.
                },

                // Methods
                niceID(email) {
                    return email || 'Guest';
                },

                handleAuth(user) {
                    this.user = user;
                    if (user) {
                        this.page = 'dashboard';
                        this.showToast('ÁôªÂÖ•ÊàêÂäü');
                        this.connState = 'online';
                        this.connText = 'Live';
                    } else {
                        this.page = 'auth';
                        this.connState = 'offline';
                        this.connText = 'Offline';
                        this.status = { inUse: false };
                    }
                },

                handleStatus(data) {
                    this.status = data || { inUse: false };
                },

                // Actions wrappers
                async updateStatus(type) {
                    try {
                        if (type === 'online') await window.actions.goOnline();
                        else await window.actions.goOffline();
                        this.showToast(type === 'online' ? 'Â∑≤‰∏äÁ∑ö' : 'Â∑≤‰∏ãÁ∑ö');
                    } catch (e) {
                        this.showToast(e.message, true);
                    }
                },

                async addFriend() {
                    if (!this.friendInput) return this.showToast('Ëº∏ÂÖ• ID', true);
                    try {
                        await window.actions.addFriend(this.friendInput);
                        this.friendInput = '';
                        this.showToast('Â∑≤ÈÄÅÁî±Ë´ãÊ±Ç');
                    } catch (e) { this.showToast('Â§±Êïó', true); }
                },

                async removeFriend(fid) {
                    await window.actions.removeFriend(fid);
                    this.showToast('Â∑≤ÁßªÈô§');
                },

                // UI Helpers
                showToast(msg, isError = false) {
                    this.toast = { visible: true, msg, isError };
                    setTimeout(() => this.toast.visible = false, 3000);
                },

                confirmAction(type) {
                    if (type === 'urgent') {
                        this.modal = {
                            type: 'confirm',
                            title: 'Á∑äÊÄ•ÊèíÈöä',
                            text: 'Á¢∫ÂÆöË¶ÅÁôºÈÄÅÁ∑äÊÄ•ÊèíÈöäÈÄöÁü•ÂóéÔºüÂ∞çÊñπÊúÉÊî∂Âà∞ÂΩàÁ™ó„ÄÇ',
                            confirmText: 'ÁôºÈÄÅ',
                            confirm: async () => {
                                await window.actions.sendUrgent();
                                this.modal.type = null;
                                this.showToast('Â∑≤ÁôºÈÄÅ');
                            }
                        };
                    }
                },

                showUrgentReceived(from) {
                    // Prevent loops
                    if (document.visibilityState === 'visible') {
                        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    }
                    this.modal = {
                        type: 'urgentRecv',
                        title: 'Á∑äÊÄ•ÊèíÈöäË´ãÊ±Ç',
                        text: `${from} ÊÄ•ÈúÄ‰ΩøÁî®ÔºåÊòØÂê¶ËÆì‰ΩçÔºü`,
                        confirmText: 'ËÆì‰Ωç (‰∏ãÁ∑ö)',
                        confirm: async () => {
                            await window.actions.goOffline(); // This handles decline/accept logic implicitly by going offline
                            this.modal.type = null;
                            this.showToast('ÊÇ®Â∑≤ËÆì‰Ωç');
                        }
                    };
                },

                copyCode() {
                    navigator.clipboard.writeText(this.user?.uid || '');
                    this.showToast('ID Â∑≤Ë§áË£Ω');
                }
            }
        }
    </script>

    <!-- Firebase Logic (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // CONFIG
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwYmhhdVdSqnLqrPOZPbeLZ1Yq4M9lSQYy-My8lITeNiVHxzDo8_kFK6AuoHLyMfeEh/exec';
        const firebaseConfig = {
            apiKey: "AIzaSyA9UtCVLFiJbM69ZViWjI7Vc-0RLm39zYc",
            authDomain: "antikick-a0da3.firebaseapp.com",
            databaseURL: "https://antikick-a0da3-default-rtdb.firebaseio.com",
            projectId: "antikick-a0da3",
            storageBucket: "antikick-a0da3.firebasestorage.app",
            messagingSenderId: "260741206992",
            appId: "1:260741206992:web:ce31872bc9776f87c31fd5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // State
        let currentUser = null;
        let gasToken = localStorage.getItem('antikick_gas_token') || '';
        let unsubscribeStatus = null;
        let unsubscribeFriends = null;

        // --- Helper to update Alpine ---
        const dispatch = (name, detail) => window.dispatchEvent(new CustomEvent(name, { detail }));
        const setGasStatus = (msg) => document.querySelector('[x-data]').__x.$data.gasStatus = msg;

        // --- Auth Listener ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            dispatch('auth-change', user ? { uid: user.uid, email: user.email } : null); // Simple User Object

            if (user) {
                // Sync User Info
                update(ref(db, 'users/' + user.uid), {
                    email: user.email || 'Guest',
                    uid: user.uid,
                    lastSeen: new Date().toISOString()
                });

                // GAS Token Sync
                api('firebaseLogin', { uid: user.uid, email: user.email || '', isAnonymous: user.isAnonymous })
                    .then(res => { if (res?.token) gasToken = res.token; });

                // Listeners
                const statusRef = ref(db, 'status');
                unsubscribeStatus = onValue(statusRef, (snap) => dispatch('status-change', snap.val()));

                const friendsRef = ref(db, 'users/' + user.uid + '/friends');
                unsubscribeFriends = onValue(friendsRef, (snap) => dispatch('friends-change', snap.val() || {}));
            } else {
                if (unsubscribeStatus) unsubscribeStatus();
                if (unsubscribeFriends) unsubscribeFriends();
            }
        });

        // --- GAS API (Stable Fetch GET) ---
        async function api(action, data = {}) {
            setGasStatus(action + '...');
            try {
                const params = new URLSearchParams({ action, token: gasToken, _t: Date.now() });
                Object.keys(data).forEach(k => params.append(k, data[k]));

                const res = await fetch(`${GAS_URL}?${params}`, { method: 'GET', headers: { Accept: 'application/json' } });
                if (!res.ok) throw new Error(res.status);

                // Unwrap JSONP if needed
                let text = await res.text();
                let json;
                try { json = JSON.parse(text); }
                catch {
                    const m = text.match(/^[^(]+\((.*)\)$/);
                    json = m ? JSON.parse(m[1]) : { success: false };
                }

                setGasStatus('Idle');
                return json;
            } catch (e) {
                console.error(e);
                setGasStatus('Error');
                return { success: false };
            }
        }

        // --- EXPOSE ACTIONS TO ALPINE ---
        window.actions = {
            loginGoogle: async () => {
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); }
                catch (e) {
                    if (e.code?.includes('unauthorized-domain')) signInAnonymously(auth);
                    else alert(e.message);
                }
            },
            loginEmail: (email, pass) => signInWithEmailAndPassword(auth, email, pass).catch(e => {
                if (e.code?.includes('user-not-found')) return createUserWithEmailAndPassword(auth, email, pass);
                throw e;
            }),
            loginGuest: () => signInAnonymously(auth),
            logout: () => signOut(auth),

            goOnline: async () => {
                if (!currentUser) return;
                api('goOnline');
                const statusRef = ref(db, 'status');
                // AutoDisconnect Logic
                await onDisconnect(statusRef).update({ inUse: false, currentUserId: null, currentUser: null });
                await update(statusRef, {
                    inUse: true,
                    currentUserId: currentUser.uid,
                    currentUser: currentUser.email || 'Guest',
                    timestamp: Date.now()
                });
            },

            goOffline: async () => {
                api('goOffline');
                const statusRef = ref(db, 'status');
                await onDisconnect(statusRef).cancel();
                await update(statusRef, { inUse: false, currentUserId: null, currentUser: null });
                // If rejecting urgent
                remove(ref(db, 'status/urgentRequest'));
            },

            sendUrgent: async () => {
                api('sendUrgent');
                await set(ref(db, 'status/urgentRequest'), { from: currentUser.email || 'Guest', ts: Date.now() });
            },

            addFriend: (id) => {
                api('addFriend', { friendCode: id });
                return set(ref(db, `users/${currentUser.uid}/friends/${id}`), { friendCode: id, name: 'Friend' });
            },

            removeFriend: (id) => {
                api('removeFriend', { friendId: id });
                return remove(ref(db, `users/${currentUser.uid}/friends/${id}`));
            }
        };
    </script>
</body>

</html>
